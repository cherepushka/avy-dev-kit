# avy - development kit

## TODO:
1. Автоматическое продления ssl сертификатов
2. Настроить apache логи

## Что это за репозиторий?
В этом репозитории находится серверное окружение для сайта `avy`  
и его сервисов. Обновление окружение происходит примерно в одно время  
вместе с выходом новых версии сайта и сервисов (для более точной  
справки ориентируйтесь на время коммитов). Окружение полностью  
написно на `docker` и может быть быстро развернуто на любом VDS.  
Все инструкции представлены ниже.  

## Предисловие
Любое даже незначительное изменение в одном с конфигурационном  
файлах (неважно будет это конфиг `apache httpd` или `mysql`  
или вообще один из `dockre-compose.yml`)  
может привести к ошибкам или неожиданным последствиям, так как  
контейнеры и композиции тесно связаны между собой.  
Так что если вы не очень знакомы с `Docker` и `Linux`,  
лучше просто следуйте инструкциям.

## Содержание

1. [Схема](#scheme)
2. [Необходимые программы](#preinstall)
3. [Установка корневого Apache](#apache-installation)
4. [avy.ru](docs/avy.ru.md)
   + [Общие шаги](docs/avy.ru.md#general)
   + [development сборка](docs/avy.ru.md#dev)
   + [production сборка](docs/avy.ru.md#prod)
5. [search.avy.ru](docs/search.avy.ru.md)
   + [Общие шаги](docs/search.avy.ru.md#general)
   + [development сборка](docs/search.avy.ru.md#dev)
   + [production сборка](docs/search.avy.ru.md#prod)
6. [Установка https](#https-install)

## <a name="scheme"></a> Схема
В корне репозитория есть Apache httpd, который запускает php  
или же отдает статику из папок сайтов (`/web-sites/*`). Сами  
настройки php, базы данных и т.д. лежат непосредственно в папках  
(`/web-sites/avy.ru` и `/web-sites/search.avy.ru`). Тоесть  
для каждого сайта работают отдельные контейнеры с php и БД.  
Стоит отметить, что `volumes` и конфиги контейнера с apache  
связаны с содержимым в папках сайтов, а также настройкой их  
`docker-compose.yml`, `Dockerfile` и т.д. Общая схема выглядит  
примерно так:
````
    apache и certbot
            |
            |___ web-sites/avy.ru (конфиги для php и БД,  
            |     а также контент сайта)
            |
            |___ web-sites/search.avy.ru (конфиги для php, БД,  
                 а также контент сайта)
````

## <a name="preinstall"></a> Необходимые программы
Для установки сервера вам понадобится только `docker` и  
`docker-compose`. Инструкцию по установке вы можете найти  
на официальном сайте. Если вы разрабатываете локально, то  
можете просто скачать `docker desktop`. Помимо визуального  
интерфейся он также включает в себя все необхидимое.

## <a name="apache-installation"></a> Установка корневого Apache
1. создайте следующие директории из корня проекта:
````
certbot/conf/
certbot/logs/
certbot/www/
````
Это нужно, чтобы генерируемые certbot сертификаты были  
доступны по unix правам для apache.
2. Далее вам нужно переименовать `.env.example` файл в корне  
на `.env`
3. Выбрать `UID` и `GID` в `.env`. Это параметры id  
пользователя и группы в unix системах. Рекомендуется просто  
выбрать одинаковые значения во всех `.env` файлах, чтобы они сов- 
падали с этими же параметрами на хост-машине. Это нужно, чтобы  
файлы которые были сгенерированы внутри контейнера были  
доступны без прав суперпользователя, а также могли открываться и  
изменяться в разных контейнерах. 
4. Далее нужно указать `ENV` переменные в `.env` файлах. Для  
корневого `.env` это означает, что при `ENV=dev` сайты будут откры-  
ваться локально по адресам `avy.loc` и `search.avy.loc`  
(не забудьте добавить эти параметры в ваш `hosts` файл) и по  
протоколу http. А при `ENV=prod` по `avy.ru` и `search.avy.ru` и    
протокол только https.

Более детальные принципы установки для  
каждого сайта:

1. [avy.ru](docs/avy.ru.md)
   + [Общие шаги](docs/avy.ru.md#general)
   + [development сборка](docs/avy.ru.md#dev)
   + [production сборка](docs/avy.ru.md#prod)
2. [search.avy.ru](docs/search.avy.ru.md)
   + [Общие шаги](docs/search.avy.ru.md#general)
   + [development сборка](docs/search.avy.ru.md#dev)
   + [production сборка](docs/search.avy.ru.md#prod)

## <a name="https-install"></a> Установка HTTPS
Установка скрипта работает засчет certbot от letsencrypt.  
Сертификаты выдаются бесплатно, срок действия - 3 месяца.  
В корневой docker-compose уже установлены скрипты для 
автопродления. Если вы проводили реконфигурацию файлов,  
то, возможно, они не будут работать, так что следите за ними.  
  

1. Чтобы установить https на `avy.ru` или `search.avy.ru`  
Остановите докер контейнер с apache-httpd (корневой  
`docker-compose`). 
2. Обязательно установите `ENV` переменную  
в корневом `.env` файле в `prod`. 
3. Затем запустите `create-ssl.sh` скрипт. Если вы устанавливаете сертификат на  
unix системах, нужно будет прописать команду `sudo chmod +x  
create-ssl.sh`, чтобы сделать его исполняемым. 
4. Далее просто следуйте инструкциям из скрипта.